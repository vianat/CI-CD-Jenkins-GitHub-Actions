pipeline {
	agent any

	stages {
		stage('Unit tests - backend') {
			parallel {
				stage('Backend') {
					steps {
						dir('bugtracker-backend') {
							sh '''
								go test -v ./... 2>&1 | go-junit-report > test-results.xml

								go test -coverprofile=coverage.out -covermode=atomic ./...
								go tool cover -html=coverage.out -o coverage.html

								mkdir -p reports
								mv coverage.html reports/
							'''
						}
					}
					post {
						always {
							junit 'bugtracker-backend/test-results.xml'
							publishHTML target: [
								reportDir: 'bugtracker-backend/reports',
								reportFiles: 'coverage.html',
								reportName: 'backend report',
							]
						}
					}
				}
				stage('UI tests - frontend') {
					steps {
						dir('bugtracker-frontend') {
							sh '''
								node --version
								npm --version

								echo "=== Current Directory ==="
								pwd
								ls -la

								echo "=== Running Tests ==="
								npm ci --no-audit
								npm test
								mkdir -p reports
								mv coverage reports/
							'''
						}
					}
					post {
						always {
							junit 'bugtracker-frontend/test-results.xml'
							publishHTML target: [
								reportDir: 'bugtracker-frontend/reports',
								reportFiles: 'coverage.html',
								reportName: 'frontend report',
							]
						}
					}
				}
			}
		}
		stage('Launch app') {
			agent {
				docker {
					image 'docker:27.5.1'
					reuseNode true
					args '-v /var/run/docker.sock:/var/run/docker.sock -u 0'
				}
			}
			steps {
				sh 'docker compose up --build -d'
			}
		}
	}
	post {
		always {
			cleanWs()
		}
	}
}