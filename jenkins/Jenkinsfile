pipeline {
	agent any

	stages {
		stage('Unit tests - backend') {
			steps {
				dir('bugtracker-backend') {
					sh '''
						go test -v ./... 2>&1 | go-junit-report > test-results.xml'

						# generate coverage report
						go test -coverprofile=coverage.out -covermode=atomic ./...
						go tool cover -html=coverage.out -o coverage.html

						mkdir -p reports
						mv coverage.html reports/

					'''
				}
			}
			post {
				always {
					junit 'bugtracker-backend/test-results.xml'
					publishHTML target: [
						reportDir: 'bugtracker-backend/reports',
						reportFiles: 'coverage.html',
						reportName: 'backend coverage report',
					]
				}
			}
		}

		stage('ui tests - frontend') {
			agent any
			steps {
				dir('bugtracker-frontend') {
					sh '''
                        node --version
                        npm --version

                        echo "=== Current Directory ==="
                        pwd
                        ls -la

                        echo "=== Running Tests ==="
                        npm ci --no-audit
                        npm test
                    '''
				}
			}
			post {
				always {
					junit 'bugtracker-frontend/test-results.xml'
				}
			}
		}
	}
}